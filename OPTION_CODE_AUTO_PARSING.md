# 期权合约代码自动解析功能说明

## 功能概述
在添加期权合约时，用户可以输入完整的期权代码（格式：`股票代码 到期日期 行权价 合约类型`），系统会自动识别并解析该代码，自动填充"行权价"、"到期日"和"合约类型"三个字段。

## 重要说明：API 限制
⚠️ **当前 Alpha Vantage API 不提供期权合约链数据**。这意味着：
- ❌ 无法通过 API 直接搜索期权合约信息
- ❌ 无法获取某个股票的所有期权合约列表
- ✅ 只能搜索股票符号以补全股票信息
- ✅ 系统通过**用户手动输入或代码自动解析**来获取期权合约详情

### 为什么?
期权合约数据涉及：
- 实时权利金（期权费）变化
- 复杂的定价模型
- 大量的数据量（单只股票可能有数百个合约）

这类数据通常由专业期权数据提供商（如 OptionChain、Quandl Pro）提供，而不是免费 API。

## 支持的格式
期权代码格式：`SYMBOL CONTRACT_TYPE YYYYMMDD STRIKE_PRICE`

### 具体示例：
- ✅ `AAPL CALL 20251215 180.00` - Apple看涨期权
- ✅ `AAPL PUT 20251215 180.50` - Apple看跌期权
- ✅ `TSLA CALL 20240117 250.00` - Tesla看涨期权

### 格式说明：
- **SYMBOL**: 股票代码（大小写不敏感，自动转为大写）
- **CONTRACT_TYPE**: 合约类型，只支持 `CALL` 或 `PUT`（大小写不敏感）
- **YYYYMMDD**: 到期日期，严格的 8 位日期格式
  - 例如：`20251215` 表示 2025 年 12 月 15 日
  - 格式：年(4位) + 月(2位) + 日(2位)
  - 月份：01-12，日期：01-31
- **STRIKE_PRICE**: 行权价，支持小数（例如：180.00、180.50）

## 工作流程

### 两种使用方式：

#### 方式一：输入完整期权代码（推荐快速）
1. 在"合约代码"字段输入完整的期权代码
2. 格式：`股票代码 合约类型 YYYYMMDD 行权价`
3. 示例：`AAPL CALL 20251215 180.00`
4. 当焦点离开输入框时，系统自动：
   - ✅ 解析期权代码
   - ✅ 自动填充行权价、到期日、合约类型
   - ✅ 显示 "✓ 代码已识别，已自动填充字段"
5. 输入期权费后保存

#### 方式二：逐字段手动填写（推荐学习）
1. **合约代码字段**：输入股票代码（如 `AAPL`）
   - 系统会搜索匹配的股票并显示列表
   - 选择一个股票自动填充代码和价格
2. **行权价**：手动输入行权价（如 `180.00`）
3. **到期日**：手动输入日期（如 `2023-12-15`）
4. **合约类型**：选择 CALL 或 PUT
5. **期权费**：输入费用后保存

### 自动解析流程（详细步骤）

#### 1. 用户输入期权代码
用户在"合约代码"字段中输入完整的期权代码。

#### 2. 自动搜索股票符号
当用户输入股票代码时，系统会通过 Alpha Vantage API 搜索匹配的股票符号。用户可以选择搜索结果中的股票来获取实时价格。

#### 3. 自动解析填充字段
当用户输入完整的期权代码（4 个以上的词语）并离开输入框（失去焦点）时：
- 系统自动解析期权代码
- 如果解析成功，自动填充：
  - **行权价**: 从代码中提取的行权价
  - **到期日**: 将 MM/DD/YY 格式转换为 YYYY-MM-DD 格式
  - **合约类型**: CALL 或 PUT
- 同时清除这些字段的错误提示

### 4. 用户反馈
- 如果代码格式正确且被成功解析，在代码字段下方显示 "✓ 代码已识别，已自动填充字段"
- 用户仍可手动修改这些字段

## 技术实现细节

### 核心函数：`parseOptionContractCode()`
```typescript
const parseOptionContractCode = (code: string): OptionContractInfo | null => {
  // 1. 分割代码为单词数组
  // 2. 验证至少有 4 个词语
  // 3. 提取最后一个词为合约类型
  // 4. 提取倒数第二个词为行权价
  // 5. 提取倒数第三个词为到期日期
  // 6. 日期格式转换
  // 7. 返回解析结果或 null
}
```

### 自动填充函数：`handleCompleteOptionCode()`
当焦点离开输入框时调用此函数：
```typescript
const handleCompleteOptionCode = (code: string) => {
  const parsed = parseOptionContractCode(code);
  if (parsed) {
    // 更新表单数据
    setFormData(prev => ({
      ...prev,
      strikePrice: parsed.strikePrice,
      expirationDate: parsed.expirationDate,
      contractType: parsed.contractType
    }));
    // 清除错误提示
    setFormErrors(prev => ({
      ...prev,
      strikePrice: '',
      expirationDate: '',
      contractType: ''
    }));
  }
}
```

## 验证规则

| 规则 | 说明 |
|------|------|
| 最少词语数 | 至少 4 个词语（使用空格分割） |
| 合约类型 | 必须是 `CALL` 或 `PUT`（大小写不敏感） |
| 行权价 | 必须是有效的数字（支持小数） |
| 到期日期 | 必须是 `MM/DD/YY` 或 `MM/DD/YYYY` 格式 |
| 日期有效性 | 必须是有效的日期 |

## 测试用例

### ✅ 有效输入
```
'AAPL CALL 20251215 180.00' 
=> {
  strikePrice: '180',
  expirationDate: '2025-12-15',
  contractType: 'CALL'
}

'AAPL PUT 20251215 180.50'
=> {
  strikePrice: '180.5',
  expirationDate: '2025-12-15',
  contractType: 'PUT'
}

'TSLA CALL 20240117 250.00'
=> {
  strikePrice: '250',
  expirationDate: '2024-01-17',
  contractType: 'CALL'
}
```

### ❌ 无效输入
```
'INVALID CODE' => null （格式错误）
'AAPL 20251215 180.00 CALL' => null （旧格式，顺序不对）
'AAPL CALL 20251215 ABC' => null （行权价不是数字）
'AAPL INVALID 20251215 180.00' => null （非法合约类型）
'AAPL CALL 202512 180.00' => null （日期位数不对，需要 8 位）
```

## 用户体验流程

1. **输入股票代码** → 系统显示搜索建议 → 选择股票
2. **完整输入期权代码** → 格式示例：`AAPL CALL 20251215 180.00`
3. **离开输入框** → 系统自动解析
4. **看到确认提示** → "✓ 代码已识别，已自动填充字段"
5. **行权价、到期日、合约类型自动填充** → 用户可选择确认或修改
6. **输入期权费** → 点击"保存"

## 日期格式说明

### 输入期权代码时的日期格式
- **格式**：`YYYYMMDD`（紧凑格式，共 8 位）
- **示例**：
  - `20251215` = 2025 年 12 月 15 日
  - `20240117` = 2024 年 1 月 17 日
  - `20250228` = 2025 年 2 月 28 日

### 系统内部存储的日期格式
- **格式**：`YYYY-MM-DD`（ISO 格式）
- **示例**：
  - `2025-12-15`
  - `2024-01-17`
  - `2025-02-28`

### 完整示例
- **用户输入**：`AAPL CALL 20251215 180.00`
- **系统解析后**：
  - 行权价：`180.00`
  - 到期日：`2025-12-15`
  - 合约类型：`CALL`

## 注意事项

- 代码解析是可选的，用户仍然可以手动输入这些字段
- 自动填充不会覆盖已有的手动修改
- 如果解析失败，用户需要手动填充这些字段
- 日期格式必须是 `YYYYMMDD`（8位数字），例如：`20251215`

## 常见问题 (FAQ)

### Q1: 为什么我搜索股票代码时看不到期权合约？
**A:** 系统搜索的是股票符号，而不是期权合约。期权合约是在股票基础之上创建的衍生品，不能单独搜索。期权合约的信息（到期日、行权价等）需要用户手动输入或通过输入完整期权代码让系统自动解析。

### Q2: 可以通过 API 查询某只股票的所有期权合约吗？
**A:** 不能。Alpha Vantage 免费 API 不提供期权链（Option Chain）数据。这类数据通常需要付费的专业数据服务（如 Polygon、OptionChain、Quandl Pro）。

### Q3: 如果我输入了 `AAPL` 但没有完整期权代码呢？
**A:** 系统会显示 AAPL 的股票搜索结果。点击结果后会填充股票代码。你仍需手动输入其他字段（行权价、到期日、合约类型）。

### Q4: 日期格式必须是 `MM/DD/YY` 吗？
**A:** 不，新格式是 `YYYYMMDD`（8位数字）。例如 `20251215` 表示 2025 年 12 月 15 日。系统会自动将其转换为内部格式 `2025-12-15`。

### Q5: 可以修改自动填充的字段吗？
**A:** 可以。自动填充只是为了方便，用户可以随时修改任何字段的值。

### Q6: 期权合约代码的搜索有什么限制吗？
**A:** 系统搜索的是**股票部分**的代码。只要输入的股票代码有效（如 AAPL、TSLA），系统就能搜索到。其他部分（日期、行权价、类型）是由用户提供的。

## 未来改进方向

如果需要更强大的期权数据功能，可考虑：
1. **集成付费期权 API**（如 Polygon、Finnhub Pro）
2. **本地期权数据库**（需要数据导入）
3. **手动期权链编辑器**（允许用户创建常见期权模板）
